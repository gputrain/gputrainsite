<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Deploying my fiirst model to HuggingFace spaces | GPU Train</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Deploying my fiirst model to HuggingFace spaces" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Steps to get the hugging face gradio application to work" />
<meta property="og:description" content="Steps to get the hugging face gradio application to work" />
<link rel="canonical" href="https://www.gputrain.com/sound/hugging%20face/fastai/2022/05/26/Deploying-my-first-HuggingFace-space.html" />
<meta property="og:url" content="https://www.gputrain.com/sound/hugging%20face/fastai/2022/05/26/Deploying-my-first-HuggingFace-space.html" />
<meta property="og:site_name" content="GPU Train" />
<meta property="og:image" content="https://www.gputrain.com/images/Hugging-Face.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-26T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://www.gputrain.com/images/Hugging-Face.png" />
<meta property="twitter:title" content="Deploying my fiirst model to HuggingFace spaces" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-26T00:00:00-05:00","datePublished":"2022-05-26T00:00:00-05:00","description":"Steps to get the hugging face gradio application to work","headline":"Deploying my fiirst model to HuggingFace spaces","image":"https://www.gputrain.com/images/Hugging-Face.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.gputrain.com/sound/hugging%20face/fastai/2022/05/26/Deploying-my-first-HuggingFace-space.html"},"url":"https://www.gputrain.com/sound/hugging%20face/fastai/2022/05/26/Deploying-my-first-HuggingFace-space.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://www.gputrain.com/feed.xml" title="GPU Train" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">GPU Train</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Joe</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Deploying my fiirst model to HuggingFace spaces</h1><p class="page-description">Steps to get the hugging face gradio application to work</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-05-26T00:00:00-05:00" itemprop="datePublished">
        May 26, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#sound">sound</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#hugging face">hugging face</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#fastai">fastai</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/gputrain/gputrainsite/tree/master/_notebooks/2022-05-26-Deploying-my-first-HuggingFace-space.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/gputrain/gputrainsite/master?filepath=_notebooks%2F2022-05-26-Deploying-my-first-HuggingFace-space.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/gputrain/gputrainsite/blob/master/_notebooks/2022-05-26-Deploying-my-first-HuggingFace-space.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Fgputrain%2Fgputrainsite%2Fblob%2Fmaster%2F_notebooks%2F2022-05-26-Deploying-my-first-HuggingFace-space.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Know-before-getting-started">Know before getting started </a></li>
<li class="toc-entry toc-h2"><a href="#Labeller-function">Labeller function </a></li>
<li class="toc-entry toc-h2"><a href="#Helpful-external-facing-markdown-text">Helpful external facing markdown text </a></li>
<li class="toc-entry toc-h2"><a href="#Inference">Inference </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Interface-options">Interface options </a></li>
<li class="toc-entry toc-h4"><a href="#Pipeline-helper-function">Pipeline helper function </a></li>
<li class="toc-entry toc-h4"><a href="#Pipeline-predict-function">Pipeline predict function </a></li>
<li class="toc-entry toc-h4"><a href="#The-Pipeleine-function">The Pipeleine function </a></li>
<li class="toc-entry toc-h4"><a href="#Launch-options">Launch options </a></li>
<li class="toc-entry toc-h4"><a href="#Gradio-local-or-public-endpoint">Gradio local or public endpoint </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Hugging-Face">Hugging Face </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-05-26-Deploying-my-first-HuggingFace-space.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Know-before-getting-started">
<a class="anchor" href="#Know-before-getting-started" aria-hidden="true"><span class="octicon octicon-link"></span></a>Know before getting started<a class="anchor-link" href="#Know-before-getting-started"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This notebook code is the same used to create my app.py file you can find in <a href="https://huggingface.co/spaces/gputrain/UrbanSounds8K/blob/main/app.py">UrbanSounds8k spaces repo</a>.</p>
<p>Creating a space is simple and intuitive at Hugging Face. You will need a "Create a new space" and "Create a new model repository" at huggingfaces. You will find the interface to create a new model repository (repo) in your profile settings.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/images/copied_from_nb/images/createmodel.PNG" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you upload your model artifacts into your spaces repository, you will run into 404 or 403 series errors. Once you create a model repo, the installation steps of Hugging Face will have an install <a href="https://git-lfs.github.com/">git lfs</a> in the set of instructions specific to the location you clone this empty repo.</p>
<p>If you upload your model artifacts into your spaces repository, you will run into 404 or 403 series errors. Once you create a model repo, the installation steps of Hugging Face will have an install git lfs in the set of instructions specific to the location you clone this empty repo.</p>
<p>Add in that repo before copying your model the *.pkl file from the earlier step; ensure you track pkl files as a type of file managed by Git LFS</p>
<p>git lfs track "*.pkl"
</p>
<div class="flash flash-success">
    <svg class="octicon octicon-checklist" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M2.5 1.75a.25.25 0 01.25-.25h8.5a.25.25 0 01.25.25v7.736a.75.75 0 101.5 0V1.75A1.75 1.75 0 0011.25 0h-8.5A1.75 1.75 0 001 1.75v11.5c0 .966.784 1.75 1.75 1.75h3.17a.75.75 0 000-1.5H2.75a.25.25 0 01-.25-.25V1.75zM4.75 4a.75.75 0 000 1.5h4.5a.75.75 0 000-1.5h-4.5zM4 7.75A.75.75 0 014.75 7h2a.75.75 0 010 1.5h-2A.75.75 0 014 7.75zm11.774 3.537a.75.75 0 00-1.048-1.074L10.7 14.145 9.281 12.72a.75.75 0 00-1.062 1.058l1.943 1.95a.75.75 0 001.055.008l4.557-4.45z"></path></svg>
    <strong>Tip: </strong>Note what is my <a href="https://huggingface.co/spaces/gputrain/UrbanSounds8K/tree/main">spaces repo</a> and what is in my <a href="https://huggingface.co/gputrain/UrbanSound8K-model/tree/main">model repo</a>
</div>
<p>If you miss this step you will run into 403 errors as you execute this line:</p>
<p>model_file = hf_hub_download("gputrain/UrbanSound8K-model", "model.pkl")</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Back to spaces repo, for which I have specific requirements.txt to be able to load librosa modules to get my inference function to work. In my example, I also needed to get my labeller function to get my model to work. This <a href="https://huggingface.co/spaces/gputrain/UrbanSounds8K/blob/main/requirements.txt">requirements.txt</a> is my spaces repo.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">gradio</span>

<span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.data.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">specgram</span>
<span class="kn">import</span> <span class="nn">librosa</span>
<span class="kn">import</span> <span class="nn">librosa.display</span>
<span class="kn">from</span> <span class="nn">huggingface_hub</span> <span class="kn">import</span> <span class="n">hf_hub_download</span>
<span class="kn">from</span> <span class="nn">fastai.learner</span> <span class="kn">import</span> <span class="n">load_learner</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Matplotlib is building the font cache; this may take a moment.
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ref_file</span> <span class="o">=</span> <span class="n">hf_hub_download</span><span class="p">(</span><span class="s2">"gputrain/UrbanSound8K-model"</span><span class="p">,</span> <span class="s2">"UrbanSound8K.csv"</span><span class="p">)</span>

<span class="n">model_file</span> <span class="o">=</span> <span class="n">hf_hub_download</span><span class="p">(</span><span class="s2">"gputrain/UrbanSound8K-model"</span><span class="p">,</span> <span class="s2">"model.pkl"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Labeller-function">
<a class="anchor" href="#Labeller-function" aria-hidden="true"><span class="octicon octicon-link"></span></a>Labeller function<a class="anchor-link" href="#Labeller-function"> </a>
</h2>
<p>My labeller function and loading of the model code are below. Model loaded and vocabulary on classes retrieved from the model object.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ref_file</span><span class="p">)</span> 
<span class="n">df</span><span class="p">[</span><span class="s1">'fname'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">'slice_file_name'</span><span class="p">,</span><span class="s1">'fold'</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">'slice_file_name'</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span><span class="o">+</span><span class="s1">'.png'</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
<span class="n">my_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span><span class="n">df</span><span class="p">[</span><span class="s1">'class'</span><span class="p">]))</span>
<span class="k">def</span> <span class="nf">label_func</span><span class="p">(</span><span class="n">f_name</span><span class="p">):</span>
    <span class="n">f_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">my_dict</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">load_learner</span> <span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">vocab</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Helpful-external-facing-markdown-text">
<a class="anchor" href="#Helpful-external-facing-markdown-text" aria-hidden="true"><span class="octicon octicon-link"></span></a>Helpful external facing markdown text<a class="anchor-link" href="#Helpful-external-facing-markdown-text"> </a>
</h2>
<p>This bit of code allows some text markdown to appear in your demo. It takes standard markdown for tables and text formats, which is very useful to provide some descriptive elements to your demo, from my spaces repo.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"article.md"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Inference">
<a class="anchor" href="#Inference" aria-hidden="true"><span class="octicon octicon-link"></span></a>Inference<a class="anchor-link" href="#Inference"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Interface-options">
<a class="anchor" href="#Interface-options" aria-hidden="true"><span class="octicon octicon-link"></span></a>Interface options<a class="anchor-link" href="#Interface-options"> </a>
</h4>
<p>The interface option allows for some text and examples objects which reside in your spaces repo.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interface_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"title"</span><span class="p">:</span> <span class="s2">"Urban Sound 8K Classification"</span><span class="p">,</span>
    <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Fast AI example of using a pre-trained Resnet34 vision model for an audio classification task on the [Urban Sounds](https://urbansounddataset.weebly.com/urbansound8k.html) dataset. "</span><span class="p">,</span>
    <span class="s2">"article"</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
    <span class="s2">"interpretation"</span><span class="p">:</span> <span class="s2">"default"</span><span class="p">,</span>
    <span class="s2">"layout"</span><span class="p">:</span> <span class="s2">"horizontal"</span><span class="p">,</span>
    <span class="c1"># Audio from validation file</span>
    <span class="s2">"examples"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"dog_bark.wav"</span><span class="p">,</span> <span class="s2">"children_playing.wav"</span><span class="p">,</span> <span class="s2">"air_conditioner.wav"</span><span class="p">,</span> <span class="s2">"street_music.wav"</span><span class="p">,</span> <span class="s2">"engine_idling.wav"</span><span class="p">,</span>
                <span class="s2">"jackhammer.wav"</span><span class="p">,</span> <span class="s2">"drilling.wav"</span><span class="p">,</span> <span class="s2">"siren.wav"</span><span class="p">,</span><span class="s2">"car_horn.wav"</span><span class="p">,</span><span class="s2">"gun_shot.wav"</span><span class="p">],</span>
    <span class="s2">"allow_flagging"</span><span class="p">:</span> <span class="s2">"never"</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Pipeline-helper-function">
<a class="anchor" href="#Pipeline-helper-function" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pipeline helper function<a class="anchor-link" href="#Pipeline-helper-function"> </a>
</h4>
<p>With my Urban Sound, 8K example, I have a custom transformation that takes the audio wav file and puts this through librosa to create a Melspectrogram. I am using a fixed temporary image as temp.png for my inference object.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">convert_sounds_melspectogram</span> <span class="p">(</span><span class="n">audio_file</span><span class="p">):</span>

    <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">audio_file</span><span class="p">)</span>  <span class="c1">#create onces with librosa</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">0.72</span><span class="p">,</span><span class="mf">0.72</span><span class="p">])</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">melS</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">melspectrogram</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">)</span>
    <span class="n">librosa</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">specshow</span><span class="p">(</span><span class="n">librosa</span><span class="o">.</span><span class="n">power_to_db</span><span class="p">(</span><span class="n">melS</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">))</span>
    <span class="n">filename</span>  <span class="o">=</span> <span class="s1">'temp.png'</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">,</span><span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">'all'</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Pipeline-predict-function">
<a class="anchor" href="#Pipeline-predict-function" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pipeline predict function<a class="anchor-link" href="#Pipeline-predict-function"> </a>
</h4>
<p>The predict function uses this temp.png file for its predictions, and the labels_probs object has a list of class probabilities.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">predict</span><span class="p">():</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">PILImage</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">'temp.png'</span><span class="p">)</span>
    <span class="n">pred</span><span class="p">,</span><span class="n">pred_idx</span><span class="p">,</span><span class="n">probs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span><span class="p">(</span><span class="n">probs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))}</span>
    <span class="k">return</span> <span class="n">labels_probs</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="The-Pipeleine-function">
<a class="anchor" href="#The-Pipeleine-function" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Pipeleine function<a class="anchor-link" href="#The-Pipeleine-function"> </a>
</h4>
<p>My inference pipeline is done in this end2endpipeline object that converts the sound and returns the output of my predict function.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">end2endpipeline</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">convert_sounds_melspectogram</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">predict</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Launch-options">
<a class="anchor" href="#Launch-options" aria-hidden="true"><span class="octicon octicon-link"></span></a>Launch options<a class="anchor-link" href="#Launch-options"> </a>
</h4>
<p>I call the gradio Interface object referencing my inference pipeline displaying input types and output classes.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">demo</span> <span class="o">=</span> <span class="n">gradio</span><span class="o">.</span><span class="n">Interface</span><span class="p">(</span>
    <span class="n">fn</span><span class="o">=</span><span class="n">end2endpipeline</span><span class="p">,</span>
    <span class="n">inputs</span><span class="o">=</span><span class="n">gradio</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">Audio</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s2">"upload"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"filepath"</span><span class="p">),</span>
    <span class="n">outputs</span><span class="o">=</span><span class="n">gradio</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">num_top_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="o">**</span><span class="n">interface_options</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Output" data-close="Show Output"></summary>
        <p>
</p>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/ec2-user/anaconda3/envs/pytorch_p38/lib/python3.8/site-packages/gradio/deprecation.py:40: UserWarning: `optional` parameter is deprecated, and it has no effect
  warnings.warn(value)
/home/ec2-user/anaconda3/envs/pytorch_p38/lib/python3.8/site-packages/gradio/deprecation.py:40: UserWarning: The 'type' parameter has been deprecated. Use the Number component instead.
  warnings.warn(value)
/home/ec2-user/anaconda3/envs/pytorch_p38/lib/python3.8/site-packages/gradio/deprecation.py:40: UserWarning: `layout` parameter is deprecated, and it has no effect
  warnings.warn(value)
</pre>
</div>
</div>

</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Gradio-local-or-public-endpoint">
<a class="anchor" href="#Gradio-local-or-public-endpoint" aria-hidden="true"><span class="octicon octicon-link"></span></a>Gradio local or public endpoint<a class="anchor-link" href="#Gradio-local-or-public-endpoint"> </a>
</h4>
<p>The launch options launches the gradio UI.  When using AWS I wasn't able to get this to work with the local URL, however if you use the share=True you get a gradio URL that works.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">launch_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"enable_queue"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">"share"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1">#"cache_examples": True,</span>
<span class="p">}</span>

<span class="n">demo</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span><span class="o">**</span><span class="n">launch_options</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Running on local URL:  http://127.0.0.1:7861/

To create a public link, set `share=True` in `launch()`.
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

        <iframe width="900" height="500" src="http://127.0.0.1:7861/" frameborder="0" allowfullscreen=""></iframe>
        
</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&lt;gradio.routes.App at 0x7f671108ce50&gt;, 'http://127.0.0.1:7861/', None)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Hugging-Face">
<a class="anchor" href="#Hugging-Face" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hugging Face<a class="anchor-link" href="#Hugging-Face"> </a>
</h2>
<p>The final end point once you assemble all this work through the logs (to resolve errors) is <a href="https://huggingface.co/spaces/gputrain/UrbanSounds8K">here</a></p>
<p><img src="/images/copied_from_nb/images/logs.PNG" alt=""></p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="gputrain/gputrainsite"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/sound/hugging%20face/fastai/2022/05/26/Deploying-my-first-HuggingFace-space.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Joseph Matthew&#39;s machine learning journey through blog and code on GPUs</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/gputrain" target="_blank" title="gputrain"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/gputrain" target="_blank" title="gputrain"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
